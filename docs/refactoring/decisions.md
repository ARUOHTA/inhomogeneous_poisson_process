# Model3リファクタリング設計決定事項

## アーキテクチャ決定

### AD-001: ディレクトリ構造
**決定日**: 2025-08-01
**決定**: bayesian_statistics/models/以下に機能別ディレクトリを作成
**理由**:
- 機能の明確な分離
- 保守性の向上
- 既存コードとの共存期間確保

```
models/
├── base/           # 共通インターフェース
├── composition/    # 産地構成比モデル
├── preprocessing/  # データ前処理
├── evaluation/     # 評価機能
├── visualization/  # 可視化機能
└── config/         # 設定・パイプライン
```

### AD-002: 共通インターフェース設計
**決定日**: 2025-08-01
**決定**: BaseCompositionModelクラスで統一インターフェース
**理由**:
- 4モデル間でfit(), predict_site_ratios(), predict_grid_ratios()が共通
- LOOCV評価の共通化が可能
- 既存コードの変更最小化

### AD-003: 可視化統合方針
**決定日**: 2025-08-01
**決定**: BaseVisualizerクラスで可視化インターフェース統一
**理由**:
- 各モデルで類似の可視化パターン
- 比較可視化の実装が容易
- 重複コード削減効果大

### AD-004: LOOCV評価統合
**決定日**: 2025-08-01
**決定**: UnifiedLOOCVEvaluatorで全モデル対応
**理由**:
- 現在NW専用の評価を全モデルで使用可能に
- 公平な比較実験が可能
- 大幅な重複コード削減

## 実装制約

### IC-001: 新機能追加禁止
**制約**: 既存機能のリファクタリングのみ実施
**対象外**: インタラクティブ可視化、新評価指標、Webアプリ等

### IC-002: コード量削減
**制約**: 総行数を現在より減少させる
**対象**: 重複コード、不要な一般化、未使用機能

### IC-003: 既存機能維持
**制約**: 現在動作している全機能を維持
**検証**: 既存ノートブックでの動作確認必須

## 移行戦略

### MS-001: 段階的移行
**戦略**: 旧コードとの共存期間を設ける
**期間**: legacy/ディレクトリで旧コード保持
**移行後**: 動作確認後に旧コード削除

### MS-002: ドキュメント駆動
**戦略**: 全変更をドキュメントで追跡
**ファイル**:
- docs/refactoring/progress.md（進捗）
- docs/refactoring/decisions.md（決定事項）
- docs/refactoring/issues.md（問題と解決）

### MS-003: 客観的品質チェック
**戦略**: Geminiとの対話による原則遵守チェック
**目的**: DRY原則、機能制限、コード量削減の客観評価
**頻度**: 各フェーズ完了時、重要な変更時
**チェック項目**:
- 重複コードの有無
- 新機能追加の有無
- コード量の増減
- 設計原則の遵守状況
