

## 6 完全条件付き分布：マーク部分

最後に，マーク（産地構成比）の NNGP 多項ロジット部分について，Polya–Gamma 拡張の形を用いた完全条件付き分布をまとめる．ここでは構造を明示することを主眼とし，導出は点過程部分と同型であるため要所のみ書く．

### 6.1 多項ロジットモデルの Polya–Gamma 形式

各遺跡 (i=1,\dots,n_X) と各カテゴリ (k=1,\dots,K-1) について，
[
\eta_{ik} = \eta_k(s_i,t_i)
= \boldsymbol{w}_z(s_i,t_i)^\top \boldsymbol{\beta}*k + u_k(s_i,t_i),
]
[
\pi*{ik}
========

\frac{\exp{\eta_{ik}}}
{1+\sum_{k'=1}^{K-1} \exp{\eta_{ik'}}},
\quad
\pi_{iK}
========

\frac{1}{1+\sum_{k'=1}^{K-1} \exp{\eta_{ik'}}},
]
とおいた．多項尤度は
[
p(\boldsymbol{y}*i \mid N_i,{\eta*{ik}})
\propto
\frac{\prod_{k=1}^K \exp{y_{ik}\eta_{ik}}}
{\Bigl(\sum_{k'=1}^K \exp{\eta_{ik'}}\Bigr)^{N_i}},
]
である．

知られているように（例：Linderman et al., 2015 など），多項ロジットは「基準カテゴリとの二項ロジットの積」に分解でき，それぞれに Polya–Gamma 変数を導入することで，(\eta_{ik}) に対して二次形式の指数として書き直すことができる．

ここでは，カテゴリ (k) ごとに独立な Polya–Gamma 変数 (\xi_{ik}) を導入し，
[
\xi_{ik} \mid \eta_{ik} \sim \mathrm{PG}\bigl(N_i,\ \eta_{ik}\bigr)
]
とすると，最終的に
[
p(\mathcal{Y} \mid {\boldsymbol{\beta}*k},{u_k},\Xi)
\propto
\prod*{k=1}^{K-1}
\exp\left{
-\frac12
(\boldsymbol{\eta}_k - \boldsymbol{z}_k)^\top
\Omega_k
(\boldsymbol{\eta}_k - \boldsymbol{z}_k)
\right},
]
という形に書ける．ここで，

* (\boldsymbol{\eta}*k = (\eta*{1k},\dots,\eta_{n_X k})^\top)
* (\Omega_k = \mathrm{diag}(\xi_{1k},\dots,\xi_{n_X k}))
* (\boldsymbol{z}*k) は，(\boldsymbol{y}*i, N_i, \xi*{ik}) から決まるベクトル（点過程部分での (\boldsymbol{z}) と同様に (\tfrac{\tilde{\kappa}*{ik}}{\xi_{ik}}) の形）

である．(\tilde{\kappa}*{ik}) の具体形は，どの分解を採用するかによって少し表現が変わるが，本質的には
[
\tilde{\kappa}*{ik} = y_{ik} - \frac{N_i}{2}
\quad\text{のような「観測−1/2×試行数」型になる}
]
と思っておくとイメージしやすい．

### 6.2 (\boldsymbol{\beta}_k, \boldsymbol{u}_k) の完全条件付き分布

カテゴリ (k) 固定で考える．(\boldsymbol{\eta}_k = W_z \boldsymbol{\beta}_k + \boldsymbol{u}_k) と書く．ここで (W_z) は，(\boldsymbol{w}_z(s_i,t_i)^\top) を行ベクトルに持つ設計行列である．事前分布は
[
\boldsymbol{\beta}_k \sim \mathcal{N}(\boldsymbol{b}_0^{(k)}, B_0^{(k)}),
\qquad
\boldsymbol{u}_k \sim \mathcal{N}(\boldsymbol{0}, Q_k^{-1})
]
とする（(Q_k) は NNGP の精度行列）．

点過程の場合と全く同様に，
[
\theta_k =
\begin{pmatrix}
\boldsymbol{\beta}*k \
\boldsymbol{u}*k
\end{pmatrix},
\quad
\mu*{0,k} =
\begin{pmatrix}
\boldsymbol{b}*0^{(k)} \
\boldsymbol{0}
\end{pmatrix},
\quad
R*{0,k} =
\begin{pmatrix}
(B_0^{(k)})^{-1} & 0 \
0 & Q_k
\end{pmatrix},
\quad
H_z = [, W_z\ \ I*{n_X} ,],
]
と置くと，(\theta_k) に関する（比例）事後密度は
[
\log p(\theta_k \mid \cdots)
============================

-\frac12 (H_z\theta_k - \boldsymbol{z}*k)^\top \Omega_k (H_z\theta_k - \boldsymbol{z}*k)
-\frac12 (\theta_k - \mu*{0,k})^\top R*{0,k}(\theta_k - \mu_{0,k})

* \text{const},
  ]
  であり，二乗完成の結果，
  [
  \boxed{
  \theta_k \mid \Xi, \mathcal{Y}, X
  \sim
  \mathcal{N}\bigl(\boldsymbol{m}*k, V_k\bigr),
  }
  ]
  [
  V_k^{-1} = H_z^\top \Omega_k H_z + R*{0,k},
  \qquad
  \boldsymbol{m}*k = V_k \bigl(H_z^\top \Omega_k \boldsymbol{z}*k + R*{0,k}\mu*{0,k}\bigr).
  ]

これを (k=1,\dots,K-1) について繰り返すことで，全てのマーク・カテゴリに対する (\boldsymbol{\beta}_k, \boldsymbol{u}_k) を更新できる．

### 6.3 Polya–Gamma 変数 (\xi_{ik}) の完全条件付き分布

各 ((i,k)) について，出てくる形は
[
\exp\Bigl{ \tilde{\kappa}*{ik}\eta*{ik} - \frac{\xi_{ik}\eta_{ik}^2}{2}\Bigr}p(\xi_{ik}),
]
という形になっているので，点過程部分と同じ議論から，
[
\boxed{
\xi_{ik} \mid \eta_{ik}, N_i
\sim
\mathrm{PG}\bigl(N_i,\ \eta_{ik}\bigr).
}
]
ここで (N_i) は遺跡 (i) での総出土数である．
