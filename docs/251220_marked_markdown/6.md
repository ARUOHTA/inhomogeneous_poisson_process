## 6 完全条件付き分布：マーク部分

本節では，Stage 2（マークの推定）における完全条件付き分布を導出する．マーク部分は時期ごとに独立であり，各時期 $t$ について以下の導出が適用される．

**重要**：異なる時期のパラメータ間に依存関係はないため，各時期の推定は完全に独立に行われる．

### 6.1 多項ロジットモデルの Polya–Gamma 形式

時期 $t$ において，各遺跡 $i \in I_t$ と各カテゴリ $k = 1, \dots, K-1$ について，
$$
\eta_{tk,i} = \eta_{tk}(s_i)
= \boldsymbol{w}_z(s_i)^\top \boldsymbol{\beta}_{tk} + u_{tk}(s_i),
$$
$$
\pi_{tk,i}
=
\frac{\exp\{\eta_{tk,i}\}}
{1+\sum_{k'=1}^{K-1} \exp\{\eta_{tk',i}\}},
\quad
\pi_{tK,i}
=
\frac{1}{1+\sum_{k'=1}^{K-1} \exp\{\eta_{tk',i}\}},
$$
とおいた．多項尤度は
$$
p(\boldsymbol{y}_{it} \mid N_{it}, \{\eta_{tk,i}\})
\propto
\frac{\prod_{k=1}^K \exp\{y_{itk}\eta_{tk,i}\}}
{\Bigl(\sum_{k'=1}^K \exp\{\eta_{tk',i}\}\Bigr)^{N_{it}}},
$$
である．

知られているように（例：Linderman et al., 2015 など），多項ロジットは「基準カテゴリとの二項ロジットの積」に分解でき，それぞれに Polya–Gamma 変数を導入することで，$\eta_{tk,i}$ に対して二次形式の指数として書き直すことができる．

ここでは，カテゴリ $k$ ごとに独立な Polya–Gamma 変数 $\xi_{itk}$ を導入し，
$$
\xi_{itk} \mid \eta_{tk,i} \sim \mathrm{PG}\bigl(N_{it},\ \eta_{tk,i}\bigr)
$$
とすると，最終的に時期 $t$ のマーク尤度は
$$
p(\mathcal{Y}_t \mid \{\boldsymbol{\beta}_{tk}\}, \{u_{tk}\}, \Xi_t)
\propto
\prod_{k=1}^{K-1}
\exp\left\{
-\frac{1}{2}
(\boldsymbol{\eta}_{tk} - \boldsymbol{z}_{tk})^\top
\Omega_{tk}
(\boldsymbol{\eta}_{tk} - \boldsymbol{z}_{tk})
\right\},
$$
という形に書ける．ここで，

- $\boldsymbol{\eta}_{tk} = (\eta_{tk,i})_{i \in I_t}$
- $\Omega_{tk} = \mathrm{diag}(\xi_{itk})_{i \in I_t}$
- $\boldsymbol{z}_{tk}$ は $\boldsymbol{y}_{it}, N_{it}, \xi_{itk}$ から決まるベクトル（$\frac{\tilde{\kappa}_{itk}}{\xi_{itk}}$ の形）

である．$\tilde{\kappa}_{itk}$ の具体形は，
$$
\tilde{\kappa}_{itk} = y_{itk} - \frac{N_{it}}{2}
\quad\text{（「観測 − 1/2 × 試行数」型）}
$$
となる．

### 6.2 $(\boldsymbol{\beta}_{tk}, \boldsymbol{u}_{tk})$ の完全条件付き分布

時期 $t$，カテゴリ $k$ を固定して考える．$\boldsymbol{\eta}_{tk} = W_z \boldsymbol{\beta}_{tk} + \boldsymbol{u}_{tk}$ と書く．ここで $W_z$ は，$\boldsymbol{w}_z(s_i)^\top$ を行ベクトルに持つ設計行列であり，行数は $n_t = |I_t|$（時期 $t$ の遺跡数）である．

事前分布は
$$
\boldsymbol{\beta}_{tk} \sim \mathcal{N}(\boldsymbol{b}_0^{(tk)}, B_0^{(tk)}),
\qquad
\boldsymbol{u}_{tk} \sim \mathcal{N}(\boldsymbol{0}, Q_{tk}^{-1})
$$
とする（$Q_{tk}$ は NNGP の精度行列）．

**距離依存事前分布**：$\boldsymbol{b}_0^{(tk)}$ の切片成分には，産地 $k$ への距離に基づく事前平均を設定することができる．

点過程の場合と全く同様に，
$$
\theta_{tk} =
\begin{pmatrix}
\boldsymbol{\beta}_{tk} \\
\boldsymbol{u}_{tk}
\end{pmatrix},
\quad
\mu_{0,tk} =
\begin{pmatrix}
\boldsymbol{b}_0^{(tk)} \\
\boldsymbol{0}
\end{pmatrix},
\quad
R_{0,tk} =
\begin{pmatrix}
(B_0^{(tk)})^{-1} & 0 \\
0 & Q_{tk}
\end{pmatrix},
\quad
H_z = [\, W_z\ \ I_{n_t} \,],
$$
と置くと，$\theta_{tk}$ に関する（比例）事後密度は
$$
\log p(\theta_{tk} \mid \cdots)
=
-\frac{1}{2} (H_z\theta_{tk} - \boldsymbol{z}_{tk})^\top \Omega_{tk} (H_z\theta_{tk} - \boldsymbol{z}_{tk})
-\frac{1}{2} (\theta_{tk} - \mu_{0,tk})^\top R_{0,tk}(\theta_{tk} - \mu_{0,tk})
+ \text{const},
$$
であり，二乗完成の結果，
$$
\boxed{
\theta_{tk} \mid \Xi_t, \mathcal{Y}_t, X_t
\sim
\mathcal{N}\bigl(\boldsymbol{m}_{tk}, V_{tk}\bigr),
}
$$
$$
V_{tk}^{-1} = H_z^\top \Omega_{tk} H_z + R_{0,tk},
\qquad
\boldsymbol{m}_{tk} = V_{tk} \bigl(H_z^\top \Omega_{tk} \boldsymbol{z}_{tk} + R_{0,tk}\mu_{0,tk}\bigr).
$$

これを $k = 1, \dots, K-1$ について繰り返すことで，時期 $t$ の全てのマーク・カテゴリに対する $(\boldsymbol{\beta}_{tk}, \boldsymbol{u}_{tk})$ を更新できる．

### 6.3 Polya–Gamma 変数 $\xi_{itk}$ の完全条件付き分布

各 $(i, k)$（$i \in I_t$，$k = 1, \dots, K-1$）について，出てくる形は
$$
\exp\Bigl\{ \tilde{\kappa}_{itk}\eta_{tk,i} - \frac{\xi_{itk}\eta_{tk,i}^2}{2}\Bigr\}p(\xi_{itk}),
$$
という形になっているので，点過程部分と同じ議論から，
$$
\boxed{
\xi_{itk} \mid \eta_{tk,i}, N_{it}
\sim
\mathrm{PG}\bigl(N_{it},\ \eta_{tk,i}\bigr).
}
$$
ここで $N_{it}$ は遺跡 $i$，時期 $t$ での総出土数である．

### 6.4 時期間の独立性

本モデルでは，異なる時期のマークパラメータは完全に独立である：
$$
p\bigl(\{\Theta_{\mathrm{mark},t}\}_{t=1}^T \mid \text{data}\bigr)
=
\prod_{t=1}^T p(\Theta_{\mathrm{mark},t} \mid X_t, \mathcal{Y}_t)
$$

この独立性により：

1. **並列計算**：各時期の推定を並列に実行可能
2. **計算効率**：各時期のデータサイズ $n_t$ は全体 $n_X$ より小さいため，個別の推定が高速
3. **柔軟性**：一部の時期のみを再推定することが容易

この構造は，仮定 2.2（マークの時期別独立性）の直接的な帰結である．
