了解です。では、先ほどまでの joint モデルに「時間依存を持つ DGP（Dynamic / Dependent GP）」をどう入れるかを、数式ベースで丁寧に書いていきます。

ここでは

* 「IPP の強度側の GP」
* 「マーク（産地比）の NNGP ロジット側の GP」

の両方に、離散時点 (t=1,\dots,T) における時間相関を入れる、という形で統一的に書きます。

---

## 8 時間依存構造を持つ DGP の導入

### 8.1 基本的な考え方

これまでの定式化では、「時期 (t) はあくまで共変量の 1 つ」であり、空間ランダム効果 (u_{\mathrm{int}}(s)) や (u_k(s)) は「空間だけの GP」として独立に定義していた。

しかし実際には、「早期の分布と中期の分布には連続性がある」「時間が近いほど似た空間パターンをとる」と考えるのが自然である。そこで、以下のような構造を導入する：

* 時間 (t=1,\dots,T) ごとに、空間ランダム効果の場 (u_{\mathrm{int}}^{(t)}(s)), (u_k^{(t)}(s)) を定義する。
* これらの場どうしに、時間方向の相関を持たせる（近い時点ほど強く相関する）。

このような「時間インデックス付き GP の族」をまとめて 1 つの GP と見る立場を、ここでは DGP と呼ぶことにする。

形式的には、領域 (\mathcal{D}\subset\mathbb{R}^2) と離散時点 (t\in{1,\dots,T}) を合わせた積空間
[
\mathcal{D}*\mathrm{st} = \mathcal{D}\times{1,\dots,T}
]
上の GP
[
u*{\mathrm{int}}(s,t),\quad u_k(s,t)
]
を定義し、共分散構造で時間依存を表現する。

---

### 8.2 強度側 DGP の具体形

IPP の強度側で用いていたロジット線形予測子は、時間を明示すると
[
\eta_{\mathrm{int}}(s,t)
========================

\boldsymbol{w}*{\mathrm{int}}(s,t)^\top\boldsymbol{\beta}*{\mathrm{int}}
+
u_{\mathrm{int}}(s,t)
]
であり、存在確率は
[
q(s,t)
======

\frac{\exp{\eta_{\mathrm{int}}(s,t)}}
{1+\exp{\eta_{\mathrm{int}}(s,t)}}.
]

ここで、(u_{\mathrm{int}}(s,t)) に対し、空間–時間 GP を
[
u_{\mathrm{int}}(\cdot,\cdot)
\sim
\mathrm{GP}\bigl(0,\ C_{\mathrm{int}}((s,t),(s',t'))\bigr)
]
として定義する。もっとも単純で扱いやすいのは「空間と時間の直積（セパラブル）共分散」であり、
[
C_{\mathrm{int}}((s,t),(s',t'))
===============================

\sigma_{\mathrm{int}}^2,
C_{\mathrm{space}}^{\mathrm{int}}(s,s';\phi_{\mathrm{int}})
,
C_{\mathrm{time}}^{\mathrm{int}}(t,t';\rho_{\mathrm{int}})
]
のように書く。ここで

* (C_{\mathrm{space}}^{\mathrm{int}}(s,s';\phi_{\mathrm{int}})) は空間距離に依存する共分散（例：指数型, Matérn など）
* (C_{\mathrm{time}}^{\mathrm{int}}(t,t';\rho_{\mathrm{int}}) = \rho_{\mathrm{int}}^{|t-t'|}) のような AR(1) 型の時間共分散
* (\sigma_{\mathrm{int}}^2) は分散スケール

とする。

このとき、観測・偽不在の点を合わせた空間–時間位置
[
(s_1,t_1),\dots,(s_n,t_n)
]
で評価したベクトル
[
\boldsymbol{u}_{\mathrm{int}}
=============================

\bigl(u_{\mathrm{int}}(s_1,t_1),\dots,u_{\mathrm{int}}(s_n,t_n)\bigr)^\top
]
は
[
\boldsymbol{u}*{\mathrm{int}}
\sim
\mathcal{N}\bigl(\boldsymbol{0},\ \Sigma*{\mathrm{int}}\bigr)
]
に従い，(\Sigma_{\mathrm{int}}) は上記カーネルから構成される共分散行列になる。

セパラブル構造を採用し，時点ごとの空間位置集合が同じ（あるいはグリッド上）であれば，
[
\Sigma_{\mathrm{int}} = \Sigma_\mathrm{time}^{\mathrm{int}}\ \otimes\ \Sigma_\mathrm{space}^{\mathrm{int}}
]
という Kronecker 積の形を持つ。ここで

* (\Sigma_\mathrm{time}^{\mathrm{int}}) は (T\times T) の時間共分散行列
* (\Sigma_\mathrm{space}^{\mathrm{int}}) は空間位置についての共分散行列

である。NNGP を使うときは、(\Sigma_\mathrm{space}^{\mathrm{int}}) をそのまま構成する代わりに、空間側のみ NNGP による疎な精度行列 (Q_{\mathrm{space}}^{\mathrm{int}}) を用い、時間側との組合せで
[
Q_{\mathrm{int}}
================

Q_\mathrm{time}^{\mathrm{int}}\ \otimes\ I
+
I\ \otimes\ Q_\mathrm{space}^{\mathrm{int}}
]
といった形の精度行列を構成する（ここは実装上の設計の余地があり、厳密な Kronecker 積か、近似的なブロック構造かを選べる）。

いずれにせよ、「(\boldsymbol{u}*{\mathrm{int}}) は多次元正規であり、事前分布は
[
\boldsymbol{u}*{\mathrm{int}} \sim \mathcal{N}(\boldsymbol{0}, Q_{\mathrm{int}}^{-1})
]
という形に保たれる」ことが重要である。

---

### 8.3 マーク側 DGP の具体形

マーク側の線形予測子も，時間を明示すると
[
\eta_k(s,t)
===========

\boldsymbol{w}_z(s,t)^\top\boldsymbol{\beta}_k
+
u_k(s,t),\quad k=1,\dots,K-1,
]
[
\pi_k(s,t)
==========

\frac{\exp{\eta_k(s,t)}}
{\sum_{k'=1}^K\exp{\eta_{k'}(s,t)}},
\quad
\eta_K(s,t)\equiv 0
]
であった。

ここでも同様に，「カテゴリ (k) ごとに空間–時間 GP を定義」する：
[
u_k(\cdot,\cdot)
\sim
\mathrm{GP}\bigl(0,\ C_k((s,t),(s',t'))\bigr),
]
[
C_k((s,t),(s',t'))
==================

\sigma_k^2,
C_{\mathrm{space}}^{(k)}(s,s';\phi_k)
,
C_{\mathrm{time}}^{(k)}(t,t';\rho_k),
]
とする。簡単のため，強度側と同じ形式（セパラブル，時間 AR(1)）を用いる。

各時期 (t) における観測遺跡 (i=1,\dots,n_{X}^{(t)}) の空間位置 (s_i^{(t)}) を集め，すべての時期をまとめたインデックスを (i=1,\dots,n_X) と書くと，
[
\boldsymbol{u}_k
================

\bigl(u_k(s_1,t_1),\dots,u_k(s_{n_X},t_{n_X})\bigr)^\top
\sim
\mathcal{N}\bigl(\boldsymbol{0}, Q_k^{-1}\bigr),
]
という形で表現できる。ここで (Q_k) は NNGP＋時間共分散から構成した精度行列である。

このようにして、IPP 強度側の (u_{\mathrm{int}}(s,t)) と、マーク側の (u_k(s,t)) の両方に対して、時間依存を持つ DGP 構造を入れたことになる。
