## Appendix B：DGP 導入後の完全条件付き分布

> **注意**：本Appendixは Appendix A の続きであり，DGP（時間依存ガウス過程）を導入した場合の完全条件付き分布を示す．本研究の主モデルでは採用していない．

---

### B.1 基本的な性質

DGP を導入しても，$\boldsymbol{u}_{\mathrm{int}}$ や $\boldsymbol{u}_k$ の事前分布は依然として多次元正規分布のままである．このため，Polya–Gamma による二乗完成の構造は崩れず，**完全条件付き分布は正規分布の形を保つ**．

違いは，事前精度行列 $Q_{\mathrm{int}}, Q_k$ の中身が，単純な空間 NNGP から「空間＋時間の DGP を反映したブロック構造」に変わる点のみである．

---

### B.2 強度側 $(\boldsymbol{\beta}_{\mathrm{int}}, \boldsymbol{u}_{\mathrm{int}})$ の更新

時間依存なしの場合と同様に：
$$
\theta_{\mathrm{int}} = \begin{pmatrix} \boldsymbol{\beta}_{\mathrm{int}} \\ \boldsymbol{u}_{\mathrm{int}} \end{pmatrix}, \quad
\mu_0 = \begin{pmatrix} \boldsymbol{b}_0^{\mathrm{int}} \\ \boldsymbol{0} \end{pmatrix}, \quad
R_0 = \begin{pmatrix} (B_0^{\mathrm{int}})^{-1} & 0 \\ 0 & Q_{\mathrm{int}} \end{pmatrix}, \quad
H = [\, W_{\mathrm{int}}\ \ I \,]
$$

ここで $Q_{\mathrm{int}}$ は DGP 付きの精度行列であり，時間相関 $\rho_{\mathrm{int}}$ やスケール $\sigma_{\mathrm{int}}^2$ が含まれる．

Polya–Gamma 拡張後の擬似尤度は以前と同じ形：
$$
L_{\mathrm{int}} \propto \exp\left\{ -\frac{1}{2} (\boldsymbol{\eta}_{\mathrm{int}} - \boldsymbol{z})^\top \Omega (\boldsymbol{\eta}_{\mathrm{int}} - \boldsymbol{z}) \right\}, \qquad \boldsymbol{\eta}_{\mathrm{int}} = H\theta_{\mathrm{int}}
$$

二乗完成の結果：
$$
\boxed{
\theta_{\mathrm{int}} \mid \boldsymbol{\omega}, X, U \sim \mathcal{N}(\boldsymbol{m}_{\mathrm{int}}, V_{\mathrm{int}})
}
$$
$$
V_{\mathrm{int}}^{-1} = H^\top \Omega H + R_0, \qquad \boldsymbol{m}_{\mathrm{int}} = V_{\mathrm{int}}(H^\top \Omega \boldsymbol{z} + R_0 \mu_0)
$$

形式は一切変わらない．違いは $R_0$ の下ブロックに DGP の精度行列 $Q_{\mathrm{int}}$ が入る点のみ．

---

### B.3 マーク側 $(\boldsymbol{\beta}_k, \boldsymbol{u}_k)$ の更新

マーク側も同様である．カテゴリ $k$ について：
$$
\theta_k = \begin{pmatrix} \boldsymbol{\beta}_k \\ \boldsymbol{u}_k \end{pmatrix}, \quad
\mu_{0,k} = \begin{pmatrix} \boldsymbol{b}_0^{(k)} \\ \boldsymbol{0} \end{pmatrix}, \quad
R_{0,k} = \begin{pmatrix} (B_0^{(k)})^{-1} & 0 \\ 0 & Q_k \end{pmatrix}, \quad
H_z = [\, W_z\ \ I \,]
$$

ここで $Q_k$ は DGP による空間–時間精度行列に置き換わっている．

Polya–Gamma 拡張後の擬似尤度：
$$
L_k \propto \exp\left\{ -\frac{1}{2} (\boldsymbol{\eta}_k - \boldsymbol{z}_k)^\top \Omega_k (\boldsymbol{\eta}_k - \boldsymbol{z}_k) \right\}, \qquad \boldsymbol{\eta}_k = H_z \theta_k
$$

完全条件付き分布：
$$
\boxed{
\theta_k \mid \Xi, \mathcal{Y}, X \sim \mathcal{N}(\boldsymbol{m}_k, V_k)
}
$$
$$
V_k^{-1} = H_z^\top \Omega_k H_z + R_{0,k}, \qquad \boldsymbol{m}_k = V_k (H_z^\top \Omega_k \boldsymbol{z}_k + R_{0,k} \mu_{0,k})
$$

---

### B.4 時間方向ハイパーパラメータの扱い

時間相関 $\rho_{\mathrm{int}}, \rho_k$ や分散 $\sigma_{\mathrm{int}}^2, \sigma_k^2$ を階層化する場合，これらにも事前分布を置くことになる．

例えば強度側で：
$$
C_{\mathrm{time}}^{\mathrm{int}}(t, t'; \rho_{\mathrm{int}}) = \rho_{\mathrm{int}}^{|t - t'|}, \quad |\rho_{\mathrm{int}}| < 1
$$
$$
p(\rho_{\mathrm{int}}) \propto 1_{(-1,1)}(\rho_{\mathrm{int}}), \quad \sigma_{\mathrm{int}}^2 \sim \mathrm{IG}(a_\sigma, b_\sigma)
$$

このとき，$\boldsymbol{u}_{\mathrm{int}}$ の事前密度：
$$
p(\boldsymbol{u}_{\mathrm{int}} \mid \rho_{\mathrm{int}}, \sigma_{\mathrm{int}}^2) \propto |\Sigma_{\mathrm{int}}|^{-1/2} \exp\left\{ -\frac{1}{2} \boldsymbol{u}_{\mathrm{int}}^\top \Sigma_{\mathrm{int}}^{-1} \boldsymbol{u}_{\mathrm{int}} \right\}
$$

が $\rho_{\mathrm{int}}, \sigma_{\mathrm{int}}^2$ に依存するため，これらの完全条件付き分布は一般に共役とならず，Metropolis–Hastings 等で更新する必要がある．

---

### B.5 実用上の選択肢

DGP 構造を入れつつ計算を簡略化する場合，以下の設計が考えられる：

1. **ハイパーパラメータ固定**：$\rho_{\mathrm{int}}, \sigma_{\mathrm{int}}^2, \phi_{\mathrm{int}}$ を事前に設定した固定値として扱う
2. **マーク側も同様**：$\rho_k, \sigma_k^2, \phi_k$ も固定値を使用

この場合，以下の全パラメータが完全にギブスサンプラーだけで更新可能：

- $\lambda^*$
- $(\boldsymbol{\beta}_{\mathrm{int}}, \boldsymbol{u}_{\mathrm{int}})$
- $(\boldsymbol{\beta}_k, \boldsymbol{u}_k)$
- Polya–Gamma 変数 $(\boldsymbol{\omega}, \Xi)$
- 偽不在点過程 $U$

---

### B.6 本研究での採用見送りの理由

本研究では DGP を採用しなかった理由：

1. **データ量の制約**：各時期の遺跡数が限られており，時間相関パラメータの安定推定が困難
2. **計算コスト**：時空間結合による精度行列の大規模化
3. **2段階推定の利点喪失**：DGP 導入により，点過程とマークの独立推定ができなくなる
4. **考古学的解釈**：時期間の独立性は，各時期の流通ネットワークが異なる可能性を許容するモデルとして妥当

将来的にデータ量が増加した場合，DGP の導入を再検討する価値がある．
