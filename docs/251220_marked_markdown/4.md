## 4 擬似尤度とデータ拡張

### 4.1 偽不在点過程の導入

点過程部分の尤度には，計算困難な積分項
$$
\iint_{\mathcal{D}} q(s,t), ds, dt
$$
が含まれている．これを回避するために，Moreira and Gamerman (2022) と同様に，偽不在を表現する補助的な非斉次ポアソン過程 $U$ を導入する．

すなわち，
$$
U \sim \mathrm{IPP}\bigl(\lambda^*(1-q)\bigr),
$$
と定義する．ここで $1-q(s,t)$ は，
$$
q(s,t)
======

\frac{\exp{\eta_{\mathrm{int}}(s,t)}}{1+\exp{\eta_{\mathrm{int}}(s,t)}}
$$
であることから，「その地点・時期に遺跡が存在しない（偽不在）相対強度」として解釈できる．

$U$ の realizations を
$$
U = {(s_j', t_j') : j=1,\dots, n_U},
$$
と書き，観測された遺跡と合わせて
$$
n = n_X + n_U,
$$
とする．便宜上，インデックス $i=1,\dots,n$ を用いて，
$$
(s_i,t_i),\quad i=1,\dots,n
$$
と表記し，$i\le n_X$ のときは真の遺跡（観測データ），$i>n_X$ のときは偽不在とする．このとき，「在／偽不在」を表す二値変数
$$
y_i =
\begin{cases}
1, & i=1,\dots,n_X,\
0, & i=n_X+1,\dots,n,
\end{cases}
$$
を導入する．

ポアソン過程の性質から，
$$
p(X \mid \lambda^*, q)
======================

\exp\left{
-\lambda^* \iint_{\mathcal{D}} q(s,t), ds, dt
\right}
(\lambda^*)^{n_X}
\prod_{i=1}^{n_X} q(s_i,t_i),
$$
$$
p(U \mid \lambda^*, q)
======================

\exp\left{
-\lambda^* \iint_{\mathcal{D}} (1-q(s,t)), ds, dt
\right}
(\lambda^*)^{n_U}
\prod_{i=n_X+1}^{n} (1-q(s_i,t_i)),
$$
であるから，両者の積をとると
[
\begin{aligned}
p(X,U \mid \lambda^*, q)
&=
p(X \mid \lambda^*, q), p(U \mid \lambda^*, q)\
&=
\exp\left{
-\lambda^*
\iint_{\mathcal{D}} \bigl(q(s,t) + 1 - q(s,t)\bigr), ds, dt
\right}
\frac{(\lambda^*)^{n}}{n_X!,n_U!}\
&\quad\times
\prod_{i=1}^{n_X} q(s_i,t_i)
\prod_{i=n_X+1}^{n} (1-q(s_i,t_i))\
&=
\exp{-\lambda^*|\mathcal{D}|}
\frac{(\lambda^*)^{n}}{n_X!,n_U!}
\prod_{i=1}^{n}
q(s_i,t_i)^{y_i}\bigl(1-q(s_i,t_i)\bigr)^{1-y_i}.
\end{aligned}
]
ここで $|\mathcal{D}| = \iint_{\mathcal{D}} 1,ds,dt$ は時空間領域の体積（面積 × 時間）である．

ロジスティック表現
$$
q(s,t)
======

\frac{\exp{\eta_{\mathrm{int}}(s,t)}}{1+\exp{\eta_{\mathrm{int}}(s,t)}}
$$
を代入すると，
[
\begin{aligned}
q^{y}(1-q)^{1-y}
&=
\left(
\frac{e^{\eta}}{1+e^{\eta}}
\right)^y
\left(
\frac{1}{1+e^{\eta}}
\right)^{1-y}\
&=
\frac{e^{y\eta}}{1+e^{\eta}},
\end{aligned}
]
であるから，$y_i$ の定義を用いて
[
\begin{aligned}
p(X,U \mid \lambda^*, \boldsymbol{\beta}*{\mathrm{int}}, u*{\mathrm{int}})
&=
\exp{-\lambda^*|\mathcal{D}|}
\frac{(\lambda^*)^{n}}{n_X!,n_U!}
\prod_{i=1}^{n}
\frac{\exp{y_i,\eta_{\mathrm{int}}(s_i,t_i)}}{1+\exp{\eta_{\mathrm{int}}(s_i,t_i)}}.
\end{aligned}
]

これは，観測点と偽不在点をまとめた「ロジスティック回帰×Poisson の混ざったような」尤度になっており，積分 $\iint q$ は消去されている．

### 4.2 マーク部分を含めた完全尤度

マーク部分の尤度は，遺跡ごとに独立と仮定すれば
$$
p(\mathcal{Y} \mid X,{\boldsymbol{\beta}_k},{u_k})
==================================================

\prod_{i=1}^{n_X}
p(\boldsymbol{y}_i \mid N_i, \boldsymbol{\pi}(s_i,t_i)),
$$
であり，
$$
p(\boldsymbol{y}_i \mid N_i, \boldsymbol{\pi}(s_i,t_i))
=======================================================

\frac{N_i!}{\prod_{k=1}^{K} y_{ik}!}
\prod_{k=1}^{K}
\pi_k(s_i,t_i)^{y_{ik}}
$$
である．多項ロジット表現を用いて，基準カテゴリ $K$ に対する $\eta_K\equiv 0$ とみなすと
[
\begin{aligned}
\pi_k(s_i,t_i)
&=
\frac{\exp{\eta_k(s_i,t_i)}}{\sum_{k'=1}^K \exp{\eta_{k'}(s_i,t_i)}},
\quad k=1,\dots,K,\
\eta_K(s_i,t_i) &= 0.
\end{aligned}
]
したがって，
[
\begin{aligned}
p(\boldsymbol{y}*i \mid N_i, {\eta_k(s_i,t_i)})
&\propto
\prod*{k=1}^K
\pi_k(s_i,t_i)^{y_{ik}}\
&=
\frac{\prod_{k=1}^K \exp{y_{ik}\eta_k(s_i,t_i)}}{\Bigl(\sum_{k'=1}^K \exp{\eta_{k'}(s_i,t_i)}\Bigr)^{N_i}}.
\end{aligned}
]
比例定数（多項係数）は，事後分布の形に関しては無視できるので，後では省略する．

したがって，点過程部分とマーク部分を合わせた「完全尤度」は
[
\begin{aligned}
&p(X,U,\mathcal{Y} \mid \Theta)\
&\propto
\exp{-\lambda^*|\mathcal{D}|}
(\lambda^*)^{n}
\prod_{i=1}^{n}
\frac{\exp{y_i,\eta_{\mathrm{int}}(s_i,t_i)}}
{1+\exp{\eta_{\mathrm{int}}(s_i,t_i)}}\
&\quad\times
\prod_{i=1}^{n_X}
\frac{\prod_{k=1}^K \exp{y_{ik}\eta_k(s_i,t_i)}}
{\Bigl(\sum_{k'=1}^K \exp{\eta_{k'}(s_i,t_i)}\Bigr)^{N_i}}.
\end{aligned}
]
ここに事前分布 $p(\Theta)$ を掛け合わせることで，事後分布が得られる．

### 4.3 Polya–Gamma データ拡張

ギブスサンプリングを導出するためには，ロジスティックおよび多項ロジットの部分を「二乗形式の指数」に変形し，正規分布との共役性を利用できる形にすることが望ましい．この目的のために，Polson et al. (2013) による Polya–Gamma データ拡張を用いる．

基本となる恒等式は次である．任意の実数 $\psi$ と $b>0$ に対して，
$$
\frac{(e^\psi)^a}{(1+e^\psi)^b}
===============================

2^{-b} \exp{\kappa \psi}
\int_0^\infty \exp\left(-\frac{\omega \psi^2}{2}\right) p(\omega), d\omega,
\quad
\kappa = a - \frac{b}{2},
$$
ただし $\omega \sim \mathrm{PG}(b,0)$ は Polya–Gamma 分布に従う．

#### 4.3.1 点過程部分への適用

点過程部分の擬似尤度は
$$
L_{\mathrm{int}}
================

\prod_{i=1}^{n}
\frac{\exp{y_i,\eta_{\mathrm{int},i}}}
{1+\exp{\eta_{\mathrm{int},i}}},
\quad
\eta_{\mathrm{int},i} = \eta_{\mathrm{int}}(s_i,t_i),
$$
と書ける（$\lambda^*$ の項や定数は取り除いてあると考える）．ここで各 $i$ について，
$$
\frac{\exp{y_i\eta_{\mathrm{int},i}}}{1+\exp{\eta_{\mathrm{int},i}}}
====================================================================

\frac{(e^{\eta_{\mathrm{int},i}})^{y_i}}{(1+e^{\eta_{\mathrm{int},i}})^1},
$$
であるから，上の恒等式を $b=1, a = y_i$ として適用すれば，
[
\begin{aligned}
\frac{\exp{y_i\eta_{\mathrm{int},i}}}{1+\exp{\eta_{\mathrm{int},i}}}
&=
2^{-1}
\exp\Bigl{\kappa_i \eta_{\mathrm{int},i}\Bigr}
\int_0^\infty
\exp\left(-\frac{\omega_i \eta_{\mathrm{int},i}^2}{2}\right)
p(\omega_i), d\omega_i,
\end{aligned}
]
となる．ここで
$$
\kappa_i = y_i - \frac{1}{2},\qquad
\omega_i \sim \mathrm{PG}(1,0).
$$

$\omega_i$ を潜在変数として導入し，$\boldsymbol{\omega}=(\omega_1,\dots,\omega_n)^\top$ に条件づけた尤度を考えると，
[
\begin{aligned}
L_{\mathrm{int}}(\boldsymbol{\eta}*{\mathrm{int}},\boldsymbol{\omega})
&\propto
\prod*{i=1}^n
\exp\Bigl{\kappa_i \eta_{\mathrm{int},i} - \frac{\omega_i \eta_{\mathrm{int},i}^2}{2}\Bigr}\
&=
\exp\left{
-\frac{1}{2}
\sum_{i=1}^n
\omega_i
\left(
\eta_{\mathrm{int},i} - \frac{\kappa_i}{\omega_i}
\right)^2
\right}
\times
\exp\left{
\frac{1}{2}
\sum_{i=1}^n
\frac{\kappa_i^2}{\omega_i}
\right},
\end{aligned}
]
となる．後者の指数項は $\eta_{\mathrm{int}}$ に依存しないので無視してよい．

いま，
$$
\boldsymbol{\eta}_{\mathrm{int}}
================================

W_{\mathrm{int}} \boldsymbol{\beta}*{\mathrm{int}}
+
\boldsymbol{u}*{\mathrm{int}},
$$
と書く（$W_{\mathrm{int}}$ は各点 $(s_i,t_i)$ における $\boldsymbol{w}*{\mathrm{int}}(s_i,t_i)^\top$ を行に持つ設計行列）．また
$$
\Omega = \mathrm{diag}(\omega_1,\dots,\omega_n),\qquad
\boldsymbol{z} =
\left(
\frac{\kappa_1}{\omega_1},\dots,\frac{\kappa_n}{\omega_n}
\right)^\top
$$
とおくと，
[
\begin{aligned}
L*{\mathrm{int}}(\boldsymbol{\beta}*{\mathrm{int}},\boldsymbol{u}*{\mathrm{int}},\boldsymbol{\omega})
&\propto
\exp\left{
-\frac{1}{2}
(\boldsymbol{\eta}*{\mathrm{int}} - \boldsymbol{z})^\top
\Omega
(\boldsymbol{\eta}*{\mathrm{int}} - \boldsymbol{z})
\right}\
&=
\exp\left{
-\frac{1}{2}
(W_{\mathrm{int}}\boldsymbol{\beta}*{\mathrm{int}} + \boldsymbol{u}*{\mathrm{int}} - \boldsymbol{z})^\top
\Omega
(W_{\mathrm{int}}\boldsymbol{\beta}*{\mathrm{int}} + \boldsymbol{u}*{\mathrm{int}} - \boldsymbol{z})
\right}.
\end{aligned}
]

これに，$\boldsymbol{\beta}*{\mathrm{int}}$ の正規事前と $\boldsymbol{u}*{\mathrm{int}}$ のガウス事前を掛け合わせると，$(\boldsymbol{\beta}*{\mathrm{int}},\boldsymbol{u}*{\mathrm{int}})$ に関しては「二乗完成」された正規分布の形になる．したがって，完全条件付き分布は多変量正規分布で与えられることが期待される．この具体的な形は，次節で導出する．

#### 4.3.2 マーク部分への Polya–Gamma の適用（概略）

マーク部分の多項ロジット尤度についても，同様の Polya–Gamma データ拡張が可能である．例えば，基準カテゴリ $K$ を除いた $k=1,\dots,K-1$ に対して，二項ロジットの形に分解し，それぞれに独立な Polya–Gamma 変数 $\xi_{ik}$ を導入することができる．

具体的には，ある $i$ と $k$ に対して，条件付きの「成功回数」 $y_{ik}$ と「試行回数」 $\tilde{N}*{ik}$ を適切に定義すると，
$$
\frac{\exp{y*{ik}\eta_{ik}}}{(1+\exp{\eta_{ik}})^{\tilde{N}*{ik}}}
$$
という形の項が現れ，先ほどと同じ恒等式を $b=\tilde{N}*{ik}$ で用いることにより，$\eta_{ik}$ に対する二次形式
$$
-\frac{1}{2}\xi_{ik}\eta_{ik}^2 + \tilde{\kappa}*{ik}\eta*{ik}
$$
として表現できる．

この操作を全ての $i,k$ について行い，Polya–Gamma 変数 $\Xi = {\xi_{ik}}$ を導入すると，マーク側の尤度も
$$
\exp\left{
-\frac{1}{2}
(\boldsymbol{\eta}_k - \boldsymbol{z}_k)^\top
\Omega_k
(\boldsymbol{\eta}_k - \boldsymbol{z}_k)
\right}
$$
という形に書ける．ここで $\boldsymbol{\eta}_k = W_z \boldsymbol{\beta}_k + \boldsymbol{u}_k$，$\Omega_k$ は対角行列，$\boldsymbol{z}*k$ は $\xi*{ik}$ から定まるベクトルである．従って，$\boldsymbol{\beta}_k$ と $\boldsymbol{u}_k$ についても，事前がガウスである限り，完全条件付き分布はガウスとなる．
