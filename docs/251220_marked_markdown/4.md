## 4 擬似尤度とデータ拡張

### 4.1 偽不在点過程の導入

点過程部分の尤度には，計算困難な積分項
$$
\int_{\mathcal{S}} q(s) \, ds
$$
が含まれている．これを回避するために，Moreira and Gamerman (2022) と同様に，偽不在を表現する補助的な非斉次ポアソン過程 $U$ を導入する．

すなわち，
$$
U \sim \mathrm{IPP}\bigl(\lambda^*(1-q)\bigr),
$$
と定義する．ここで $1-q(s)$ は，
$$
q(s) = \frac{\exp\{\eta_{\mathrm{int}}(s)\}}{1+\exp\{\eta_{\mathrm{int}}(s)\}}
$$
であることから，「その地点に遺跡が存在しない（偽不在）相対強度」として解釈できる．

**注意**：本モデルでは偽不在点過程も時間依存を持たない．これは点過程部分全体が全時期で共通であることの帰結である．

$U$ の実現を
$$
U = \{s_j' : j=1,\dots, n_U\},
$$
と書き，観測された遺跡と合わせて
$$
n = n_X + n_U,
$$
とする．便宜上，インデックス $i=1,\dots,n$ を用いて，
$$
s_i, \quad i=1,\dots,n
$$
と表記し，$i \le n_X$ のときは真の遺跡（観測データ），$i > n_X$ のときは偽不在とする．このとき，「在／偽不在」を表す二値変数
$$
y_i =
\begin{cases}
1, & i=1,\dots,n_X,\\
0, & i=n_X+1,\dots,n,
\end{cases}
$$
を導入する．

#### 結合尤度の導出

ポアソン過程の性質から，
$$
p(X_{\mathrm{all}} \mid \lambda^*, q) = \exp\left\{-\lambda^* \int_{\mathcal{S}} q(s) \, ds\right\} (\lambda^*)^{n_X} \prod_{i=1}^{n_X} q(s_i),
$$
$$
p(U \mid \lambda^*, q) = \exp\left\{-\lambda^* \int_{\mathcal{S}} (1-q(s)) \, ds\right\} (\lambda^*)^{n_U} \prod_{i=n_X+1}^{n} (1-q(s_i)),
$$
であるから，両者の積をとると
$$
\begin{aligned}
p(X_{\mathrm{all}}, U \mid \lambda^*, q)
&= p(X_{\mathrm{all}} \mid \lambda^*, q) \cdot p(U \mid \lambda^*, q)\\
&= \exp\left\{-\lambda^* \int_{\mathcal{S}} \bigl(q(s) + 1 - q(s)\bigr) \, ds\right\} \frac{(\lambda^*)^{n}}{n_X! \, n_U!}\\
&\quad\times \prod_{i=1}^{n_X} q(s_i) \prod_{i=n_X+1}^{n} (1-q(s_i))\\
&= \exp\{-\lambda^*|\mathcal{S}|\} \frac{(\lambda^*)^{n}}{n_X! \, n_U!} \prod_{i=1}^{n} q(s_i)^{y_i}\bigl(1-q(s_i)\bigr)^{1-y_i}.
\end{aligned}
$$
ここで $|\mathcal{S}| = \int_{\mathcal{S}} 1 \, ds$ は空間領域の面積である．

#### ロジスティック形式への変換

ロジスティック表現
$$
q(s) = \frac{\exp\{\eta_{\mathrm{int}}(s)\}}{1+\exp\{\eta_{\mathrm{int}}(s)\}}
$$
を代入すると，
$$
\begin{aligned}
q^{y}(1-q)^{1-y}
&= \left(\frac{e^{\eta}}{1+e^{\eta}}\right)^y \left(\frac{1}{1+e^{\eta}}\right)^{1-y}\\
&= \frac{e^{y\eta}}{1+e^{\eta}},
\end{aligned}
$$
であるから，$y_i$ の定義を用いて
$$
\begin{aligned}
p(X_{\mathrm{all}}, U \mid \lambda^*, \boldsymbol{\beta}_{\mathrm{int}}, u_{\mathrm{int}})
&= \exp\{-\lambda^*|\mathcal{S}|\} \frac{(\lambda^*)^{n}}{n_X! \, n_U!} \prod_{i=1}^{n} \frac{\exp\{y_i \eta_{\mathrm{int}}(s_i)\}}{1+\exp\{\eta_{\mathrm{int}}(s_i)\}}.
\end{aligned}
$$

これは，観測点と偽不在点をまとめた「ロジスティック回帰 × Poisson の混ざったような」尤度になっており，**積分 $\int q$ は消去されている**．

### 4.2 完全尤度：点過程部分とマーク部分の分離

§3.3 の因子分解により，完全尤度は点過程部分とマーク部分に分離される．

#### 点過程部分の尤度（偽不在込み）

偽不在 $U$ を含めた点過程部分の尤度は：
$$
p(X_{\mathrm{all}}, U \mid \Theta_{\mathrm{int}})
\propto
\exp\{-\lambda^*|\mathcal{S}|\}
(\lambda^*)^{n}
\prod_{i=1}^{n}
\frac{\exp\{y_i \eta_{\mathrm{int}}(s_i)\}}
{1+\exp\{\eta_{\mathrm{int}}(s_i)\}}
$$

#### マーク部分の尤度（時期別独立）

マーク部分の尤度は，各時期について独立に与えられる．時期 $t$ における尤度は：
$$
p(\mathcal{Y}_t \mid X_t, \Theta_{\mathrm{mark},t})
=
\prod_{i \in I_t}
p(\boldsymbol{y}_{it} \mid N_{it}, \boldsymbol{\pi}_t(s_i)),
$$
であり，
$$
p(\boldsymbol{y}_{it} \mid N_{it}, \boldsymbol{\pi}_t(s_i))
=
\frac{N_{it}!}{\prod_{k=1}^{K} y_{itk}!}
\prod_{k=1}^{K}
\pi_{tk}(s_i)^{y_{itk}}
$$
である．

多項ロジット表現を用いて，基準カテゴリ $K$ に対する $\eta_{tK} \equiv 0$ とみなすと
$$
\begin{aligned}
\pi_{tk}(s_i)
&= \frac{\exp\{\eta_{tk}(s_i)\}}{\sum_{k'=1}^K \exp\{\eta_{tk'}(s_i)\}}, \quad k=1,\dots,K,\\
\eta_{tK}(s_i) &= 0.
\end{aligned}
$$
したがって，
$$
\begin{aligned}
p(\boldsymbol{y}_{it} \mid N_{it}, \{\eta_{tk}(s_i)\})
&\propto
\prod_{k=1}^K
\pi_{tk}(s_i)^{y_{itk}}\\
&=
\frac{\prod_{k=1}^K \exp\{y_{itk}\eta_{tk}(s_i)\}}{\Bigl(\sum_{k'=1}^K \exp\{\eta_{tk'}(s_i)\}\Bigr)^{N_{it}}}.
\end{aligned}
$$
比例定数（多項係数）は，事後分布の形に関しては無視できるので，後では省略する．

#### 完全尤度のまとめ

以上をまとめると，完全尤度は
$$
\boxed{
\begin{aligned}
&p(X_{\mathrm{all}}, U, \{\mathcal{Y}_t\}_{t=1}^T \mid \Theta)\\
&\propto
\underbrace{
\exp\{-\lambda^*|\mathcal{S}|\}
(\lambda^*)^{n}
\prod_{i=1}^{n}
\frac{\exp\{y_i \eta_{\mathrm{int}}(s_i)\}}
{1+\exp\{\eta_{\mathrm{int}}(s_i)\}}
}_{\text{点過程部分（偽不在込み）}}\\
&\quad\times
\prod_{t=1}^T
\underbrace{
\prod_{i \in I_t}
\frac{\prod_{k=1}^K \exp\{y_{itk}\eta_{tk}(s_i)\}}
{\Bigl(\sum_{k'=1}^K \exp\{\eta_{tk'}(s_i)\}\Bigr)^{N_{it}}}
}_{\text{マーク部分（時期 $t$）}}
\end{aligned}
}
$$
となる．ここに事前分布 $p(\Theta)$ を掛け合わせることで，事後分布が得られる．

### 4.3 Polya–Gamma データ拡張

ギブスサンプリングを導出するためには，ロジスティックおよび多項ロジットの部分を「二乗形式の指数」に変形し，正規分布との共役性を利用できる形にすることが望ましい．この目的のために，Polson et al. (2013) による Polya–Gamma データ拡張を用いる．

基本となる恒等式は次である．任意の実数 $\psi$ と $b>0$ に対して，
$$
\frac{(e^\psi)^a}{(1+e^\psi)^b}
=
2^{-b} \exp\{\kappa \psi\}
\int_0^\infty \exp\left(-\frac{\omega \psi^2}{2}\right) p(\omega) \, d\omega,
\quad
\kappa = a - \frac{b}{2},
$$
ただし $\omega \sim \mathrm{PG}(b,0)$ は Polya–Gamma 分布に従う．

#### 4.3.1 点過程部分への適用

点過程部分の擬似尤度は
$$
L_{\mathrm{int}}
=
\prod_{i=1}^{n}
\frac{\exp\{y_i \eta_{\mathrm{int},i}\}}
{1+\exp\{\eta_{\mathrm{int},i}\}},
\quad
\eta_{\mathrm{int},i} = \eta_{\mathrm{int}}(s_i),
$$
と書ける（$\lambda^*$ の項や定数は取り除いてあると考える）．ここで各 $i$ について，
$$
\frac{\exp\{y_i\eta_{\mathrm{int},i}\}}{1+\exp\{\eta_{\mathrm{int},i}\}}
=
\frac{(e^{\eta_{\mathrm{int},i}})^{y_i}}{(1+e^{\eta_{\mathrm{int},i}})^1},
$$
であるから，上の恒等式を $b=1, a = y_i$ として適用すれば，
$$
\begin{aligned}
\frac{\exp\{y_i\eta_{\mathrm{int},i}\}}{1+\exp\{\eta_{\mathrm{int},i}\}}
&=
2^{-1}
\exp\Bigl\{\kappa_i \eta_{\mathrm{int},i}\Bigr\}
\int_0^\infty
\exp\left(-\frac{\omega_i \eta_{\mathrm{int},i}^2}{2}\right)
p(\omega_i) \, d\omega_i,
\end{aligned}
$$
となる．ここで
$$
\kappa_i = y_i - \frac{1}{2}, \qquad
\omega_i \sim \mathrm{PG}(1,0).
$$

$\omega_i$ を潜在変数として導入し，$\boldsymbol{\omega}=(\omega_1,\dots,\omega_n)^\top$ に条件づけた尤度を考えると，
$$
\begin{aligned}
L_{\mathrm{int}}(\boldsymbol{\eta}_{\mathrm{int}},\boldsymbol{\omega})
&\propto
\prod_{i=1}^n
\exp\Bigl\{\kappa_i \eta_{\mathrm{int},i} - \frac{\omega_i \eta_{\mathrm{int},i}^2}{2}\Bigr\}\\
&=
\exp\left\{
-\frac{1}{2}
\sum_{i=1}^n
\omega_i
\left(
\eta_{\mathrm{int},i} - \frac{\kappa_i}{\omega_i}
\right)^2
\right\}
\times
\exp\left\{
\frac{1}{2}
\sum_{i=1}^n
\frac{\kappa_i^2}{\omega_i}
\right\},
\end{aligned}
$$
となる．後者の指数項は $\eta_{\mathrm{int}}$ に依存しないので無視してよい．

いま，
$$
\boldsymbol{\eta}_{\mathrm{int}}
=
W_{\mathrm{int}} \boldsymbol{\beta}_{\mathrm{int}}
+
\boldsymbol{u}_{\mathrm{int}},
$$
と書く（$W_{\mathrm{int}}$ は各点 $s_i$ における $\boldsymbol{w}_{\mathrm{int}}(s_i)^\top$ を行に持つ設計行列）．また
$$
\Omega = \mathrm{diag}(\omega_1,\dots,\omega_n), \qquad
\boldsymbol{z} =
\left(
\frac{\kappa_1}{\omega_1},\dots,\frac{\kappa_n}{\omega_n}
\right)^\top
$$
とおくと，
$$
\begin{aligned}
L_{\mathrm{int}}(\boldsymbol{\beta}_{\mathrm{int}},\boldsymbol{u}_{\mathrm{int}},\boldsymbol{\omega})
&\propto
\exp\left\{
-\frac{1}{2}
(\boldsymbol{\eta}_{\mathrm{int}} - \boldsymbol{z})^\top
\Omega
(\boldsymbol{\eta}_{\mathrm{int}} - \boldsymbol{z})
\right\}\\
&=
\exp\left\{
-\frac{1}{2}
(W_{\mathrm{int}}\boldsymbol{\beta}_{\mathrm{int}} + \boldsymbol{u}_{\mathrm{int}} - \boldsymbol{z})^\top
\Omega
(W_{\mathrm{int}}\boldsymbol{\beta}_{\mathrm{int}} + \boldsymbol{u}_{\mathrm{int}} - \boldsymbol{z})
\right\}.
\end{aligned}
$$

これに，$\boldsymbol{\beta}_{\mathrm{int}}$ の正規事前と $\boldsymbol{u}_{\mathrm{int}}$ のガウス事前を掛け合わせると，$(\boldsymbol{\beta}_{\mathrm{int}},\boldsymbol{u}_{\mathrm{int}})$ に関しては「二乗完成」された正規分布の形になる．したがって，完全条件付き分布は多変量正規分布で与えられることが期待される．この具体的な形は，次節で導出する．

#### 4.3.2 マーク部分への Polya–Gamma の適用

マーク部分の多項ロジット尤度についても，同様の Polya–Gamma データ拡張が可能である．各時期 $t$ について独立に適用される点に注意する．

時期 $t$ において，基準カテゴリ $K$ を除いた $k=1,\dots,K-1$ に対して，二項ロジットの形に分解し，それぞれに独立な Polya–Gamma 変数 $\xi_{itk}$ を導入することができる．

具体的には，遺跡 $i \in I_t$ とカテゴリ $k$ に対して，条件付きの「成功回数」 $y_{itk}$ と「試行回数」 $\tilde{N}_{itk}$ を適切に定義すると，
$$
\frac{\exp\{y_{itk}\eta_{tk}(s_i)\}}{(1+\exp\{\eta_{tk}(s_i)\})^{\tilde{N}_{itk}}}
$$
という形の項が現れ，先ほどと同じ恒等式を $b=\tilde{N}_{itk}$ で用いることにより，$\eta_{tk}(s_i)$ に対する二次形式
$$
-\frac{1}{2}\xi_{itk}\eta_{tk}(s_i)^2 + \tilde{\kappa}_{itk}\eta_{tk}(s_i)
$$
として表現できる．

この操作を全ての $i \in I_t, k=1,\dots,K-1$ について行い，Polya–Gamma 変数 $\Xi_t = \{\xi_{itk}\}$ を導入すると，時期 $t$ のマーク側の尤度も
$$
\exp\left\{
-\frac{1}{2}
(\boldsymbol{\eta}_{tk} - \boldsymbol{z}_{tk})^\top
\Omega_{tk}
(\boldsymbol{\eta}_{tk} - \boldsymbol{z}_{tk})
\right\}
$$
という形に書ける．ここで $\boldsymbol{\eta}_{tk} = W_z \boldsymbol{\beta}_{tk} + \boldsymbol{u}_{tk}$，$\Omega_{tk}$ は対角行列，$\boldsymbol{z}_{tk}$ は $\xi_{itk}$ から定まるベクトルである．

**重要**：$\tilde{\kappa}_{itk}$ の具体形は，
$$
\tilde{\kappa}_{itk} = y_{itk} - \frac{N_{it}}{2}
$$
という「観測 − 1/2 × 試行数」型となる．

従って，$\boldsymbol{\beta}_{tk}$ と $\boldsymbol{u}_{tk}$ についても，事前がガウスである限り，完全条件付き分布はガウスとなる．
