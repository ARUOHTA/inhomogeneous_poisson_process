## 7 ギブスサンプリングアルゴリズム

本モデルでは，尤度の因子分解（定理 3.1）を利用した2段階推定を採用する．これにより，点過程部分とマーク部分を独立に推定することができ，計算効率と推定の安定性が向上する．

### 7.1 2段階推定の概要

**Stage 1（点過程の推定）**：全時期のデータ $X_{\mathrm{all}}$ を用いて，点過程パラメータ $\Theta_{\mathrm{int}} = \{\lambda^*, \boldsymbol{\beta}_{\mathrm{int}}, u_{\mathrm{int}}(\cdot)\}$ を推定する．

**Stage 2（マークの推定）**：各時期 $t = 1, \dots, T$ について独立に，$X_t, \mathcal{Y}_t$ を用いてマークパラメータ $\Theta_{\mathrm{mark},t} = \{\{\boldsymbol{\beta}_{tk}\}, \{u_{tk}(\cdot)\}\}$ を推定する．

この2段階推定が理論的に正当化される理由は，事後分布が以下のように分解されるためである（§3.3 参照）：
$$
p(\Theta \mid \text{data})
\propto
\underbrace{p(X_{\mathrm{all}} \mid \Theta_{\mathrm{int}}) p(\Theta_{\mathrm{int}})}_{\text{Stage 1}}
\times
\prod_{t=1}^T
\underbrace{p(\mathcal{Y}_t \mid X_t, \Theta_{\mathrm{mark},t}) p(\Theta_{\mathrm{mark},t})}_{\text{Stage 2}}
$$

---

### 7.2 Stage 1: 点過程のギブスサンプリング

#### 入力
- $X_{\mathrm{all}} = \{s_1, \dots, s_{n_X}\}$：全時期の遺跡座標
- $W_{\mathrm{int}}$：設計行列
- $|\mathcal{S}|$：空間領域の面積
- ハイパーパラメータ：$m_0, r_0, \boldsymbol{b}_0^{\mathrm{int}}, B_0^{\mathrm{int}}, Q_{\mathrm{int}}$

#### 初期値設定

$$
\lambda^{*(0)},\
\boldsymbol{\beta}_{\mathrm{int}}^{(0)},\
\boldsymbol{u}_{\mathrm{int}}^{(0)},\
\boldsymbol{\omega}^{(0)},\
U^{(0)}
$$
を適当に設定する．

#### 反復（$\tau = 1, \dots, T_{\mathrm{int}}$）

各反復で以下のステップを実行する：

**(a) 偽不在の更新**

$$
U^{(\tau)} \sim \mathrm{IPP}\bigl(\lambda^{*(\tau-1)}(1-q^{(\tau-1)})\bigr)
$$

を Poisson thinning によってサンプルする：

1. $N \sim \mathrm{Poisson}(\lambda^{*(\tau-1)} |\mathcal{S}|)$ をサンプル
2. $j = 1, \dots, N$ について，$s_j \sim \mathrm{Uniform}(\mathcal{S})$ を独立にサンプルし，$\eta_{\mathrm{int}}(s_j), q(s_j)$ を計算
3. $u_j \sim \mathrm{Uniform}(0,1)$ をサンプリングし，$u_j < 1 - q(s_j)$ のときのみ $s_j$ を $U^{(\tau)}$ に採用

**(b) 点過程側 Polya–Gamma の更新**

$$
\omega_i^{(\tau)} \sim \mathrm{PG}\bigl(1,\ \eta_{\mathrm{int},i}^{(\tau-1)}\bigr), \quad i = 1, \dots, n^{(\tau)}
$$

ここで $n^{(\tau)} = n_X + n_U^{(\tau)}$．

**(c) $(\boldsymbol{\beta}_{\mathrm{int}}, \boldsymbol{u}_{\mathrm{int}})$ の更新**

$$
\theta_{\mathrm{int}}^{(\tau)}
=
\begin{pmatrix}
\boldsymbol{\beta}_{\mathrm{int}}^{(\tau)} \\
\boldsymbol{u}_{\mathrm{int}}^{(\tau)}
\end{pmatrix}
\sim
\mathcal{N}\bigl(\boldsymbol{m}_{\mathrm{int}}, V_{\mathrm{int}}\bigr)
$$

ただし
$$
V_{\mathrm{int}}^{-1} = H^\top \Omega^{(\tau)} H + R_0, \qquad
\boldsymbol{m}_{\mathrm{int}} = V_{\mathrm{int}}(H^\top \Omega^{(\tau)} \boldsymbol{z}^{(\tau)} + R_0 \mu_0)
$$

ここで
$$
H = [W_{\mathrm{int}} \ \ I_n], \quad
R_0 = \begin{pmatrix} (B_0^{\mathrm{int}})^{-1} & 0 \\ 0 & Q_{\mathrm{int}} \end{pmatrix}, \quad
\mu_0 = \begin{pmatrix} \boldsymbol{b}_0^{\mathrm{int}} \\ \boldsymbol{0} \end{pmatrix}
$$

**(d) $\lambda^*$ の更新**

$$
\lambda^{*(\tau)} \sim \mathrm{Gamma}\bigl(m_0 + n^{(\tau)},\ r_0 + |\mathcal{S}|\bigr)
$$

#### 出力
- $\{\lambda^{*(\tau)}\}_{\tau > \text{burn-in}}$：$\lambda^*$ の事後サンプル
- $\{\boldsymbol{\beta}_{\mathrm{int}}^{(\tau)}\}$：$\boldsymbol{\beta}_{\mathrm{int}}$ の事後サンプル
- $\{\boldsymbol{u}_{\mathrm{int}}^{(\tau)}\}$：$\boldsymbol{u}_{\mathrm{int}}$ の事後サンプル

---

### 7.3 Stage 2: マークのギブスサンプリング（時期別・独立）

各時期 $t = 1, \dots, T$ について，以下のアルゴリズムを**独立に**実行する．

#### 入力
- $X_t = \{s_i : i \in I_t\}$：時期 $t$ の遺跡座標
- $\mathcal{Y}_t = \{\boldsymbol{y}_{it} : i \in I_t\}$：時期 $t$ のマークデータ
- $W_z$：設計行列
- ハイパーパラメータ：$\boldsymbol{b}_0^{(tk)}, B_0^{(tk)}, Q_{tk}$（各 $k = 1, \dots, K-1$）

#### 初期値設定

$$
\{\boldsymbol{\beta}_{tk}^{(0)}, \boldsymbol{u}_{tk}^{(0)}\}_{k=1}^{K-1},\
\Xi_t^{(0)}
$$
を適当に設定する．

#### 反復（$\tau = 1, \dots, T_{\mathrm{mark}}$）

各反復で以下のステップを実行する：

**(e) マーク側 Polya–Gamma の更新**

各 $i \in I_t$，$k = 1, \dots, K-1$ について
$$
\xi_{itk}^{(\tau)} \sim \mathrm{PG}\bigl(N_{it},\ \eta_{tk,i}^{(\tau-1)}\bigr)
$$

**(f) 各カテゴリ $k$ の $(\boldsymbol{\beta}_{tk}, \boldsymbol{u}_{tk})$ の更新**

$$
\theta_{tk}^{(\tau)}
=
\begin{pmatrix}
\boldsymbol{\beta}_{tk}^{(\tau)} \\
\boldsymbol{u}_{tk}^{(\tau)}
\end{pmatrix}
\sim
\mathcal{N}\bigl(\boldsymbol{m}_{tk}, V_{tk}\bigr)
$$

ただし
$$
V_{tk}^{-1} = H_z^\top \Omega_{tk}^{(\tau)} H_z + R_{0,tk}, \qquad
\boldsymbol{m}_{tk} = V_{tk}(H_z^\top \Omega_{tk}^{(\tau)} \boldsymbol{z}_{tk}^{(\tau)} + R_{0,tk} \mu_{0,tk})
$$

ここで
$$
H_z = [W_z \ \ I_{n_t}], \quad
R_{0,tk} = \begin{pmatrix} (B_0^{(tk)})^{-1} & 0 \\ 0 & Q_{tk} \end{pmatrix}, \quad
\mu_{0,tk} = \begin{pmatrix} \boldsymbol{b}_0^{(tk)} \\ \boldsymbol{0} \end{pmatrix}
$$

$n_t = |I_t|$ は時期 $t$ の遺跡数．

#### 出力（時期 $t$ について）
- $\{\boldsymbol{\beta}_{tk}^{(\tau)}\}_{k=1}^{K-1}$：回帰係数の事後サンプル
- $\{\boldsymbol{u}_{tk}^{(\tau)}\}_{k=1}^{K-1}$：空間効果の事後サンプル

---

### 7.4 アルゴリズムのまとめ

```
Algorithm: 2段階ギブスサンプリング

[Stage 1: 点過程（1回実行）]
入力: X_all（全時期の遺跡座標）
for τ = 1, ..., T_int:
    (a) U ~ IPP(λ*(1-q))  [Poisson thinning]
    (b) ω_i ~ PG(1, η_int,i)  for i = 1,...,n
    (c) (β_int, u_int) ~ N(m_int, V_int)
    (d) λ* ~ Gamma(m₀ + n, r₀ + |S|)
出力: λ*, β_int, u_int の事後サンプル

[Stage 2: マーク（T回実行、各時期独立）]
for t = 1, ..., T:
    入力: X_t, Y_t（時期tのデータ）
    for τ = 1, ..., T_mark:
        (e) ξ_{itk} ~ PG(N_{it}, η_{tk,i})  for i∈I_t, k=1,...,K-1
        (f) (β_{tk}, u_{tk}) ~ N(m_{tk}, V_{tk})  for k=1,...,K-1
    出力: β_{tk}, u_{tk} の事後サンプル（k=1,...,K-1）
```

---

### 7.5 計算量の考察

2段階推定による計算量の削減効果を分析する．

#### Stage 1（点過程）
- 遺跡数：$n_X$（全時期合計）
- NNGP による近似を用いれば，1回の更新は $O(n_X \cdot M^3)$（$M$ は近傍数）

#### Stage 2（マーク）
- 各時期の遺跡数：$n_t = |I_t|$（通常 $n_t \ll n_X$）
- 時期ごとの更新は $O(n_t \cdot M^3)$
- $T$ 時期の合計は $O\bigl(\sum_{t=1}^T n_t \cdot M^3\bigr) = O(n_X \cdot M^3)$

#### 全体の計算量
2段階推定全体の計算量は，時期別同時推定と比較して大幅に削減される．特に，Stage 2 の各時期の推定は**並列化可能**である点が重要である．

---

### 7.6 将来の拡張可能性

本アルゴリズムは，以下のような拡張が考えられる：

1. **時期間の空間パターン相関**：マーク部分の潜在場 $u_{tk}(s)$ に時間方向の相関（DGP）を導入することで，隣接時期間で類似した空間パターンを仮定できる．この場合，Stage 2 は時期別独立ではなく，全時期を同時に推定する形に修正される．

2. **点過程の時期別λ*\**：立地選好の空間パターン $q(s)$ は共有しつつ，時期ごとの遺跡総数の違いを $\lambda^*_t$ で吸収する半共有モデル．

これらの拡張は，データ量や考古学的解釈の必要性に応じて検討する価値がある．
