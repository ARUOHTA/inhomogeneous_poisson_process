## 5 完全条件付き分布：点過程部分

本節では，Stage 1（点過程の推定）における完全条件付き分布を導出する．点過程部分は全時期で共通であり，時間インデックス $t$ は現れないことに注意する．

### 5.1 $(\boldsymbol{\beta}_{\mathrm{int}}, \boldsymbol{u}_{\mathrm{int}})$ の完全条件付き分布

点過程部分で導入した擬似尤度は（§4.3.1 参照）
$$
L_{\mathrm{int}}
\propto
\exp\left\{
-\frac{1}{2}
(\boldsymbol{\eta}_{\mathrm{int}} - \boldsymbol{z})^\top
\Omega
(\boldsymbol{\eta}_{\mathrm{int}} - \boldsymbol{z})
\right\},
$$
$$
\boldsymbol{\eta}_{\mathrm{int}}
=
W_{\mathrm{int}}\boldsymbol{\beta}_{\mathrm{int}} + \boldsymbol{u}_{\mathrm{int}},
\quad
\Omega = \mathrm{diag}(\omega_1,\dots,\omega_n),
\quad
\boldsymbol{z}=\left(\frac{\kappa_1}{\omega_1},\dots,\frac{\kappa_n}{\omega_n}\right)^\top,
$$
$$
\kappa_i = y_i - \frac{1}{2}.
$$

ここで $n = n_X + n_U$（全時期の遺跡数 + 偽不在点数）である．

事前分布は
$$
\boldsymbol{\beta}_{\mathrm{int}}
\sim
\mathcal{N}(\boldsymbol{b}_0^{\mathrm{int}}, B_0^{\mathrm{int}}),
\qquad
\boldsymbol{u}_{\mathrm{int}}
\sim
\mathcal{N}(\boldsymbol{0}, Q_{\mathrm{int}}^{-1}),
$$
とする（$Q_{\mathrm{int}}$ は NNGP から得られる精度行列）．

ここで
$$
\theta_{\mathrm{int}}
=
\begin{pmatrix}
\boldsymbol{\beta}_{\mathrm{int}} \\
\boldsymbol{u}_{\mathrm{int}}
\end{pmatrix},
\qquad
\mu_0 =
\begin{pmatrix}
\boldsymbol{b}_0^{\mathrm{int}} \\
\boldsymbol{0}
\end{pmatrix},
\qquad
R_0 =
\begin{pmatrix}
(B_0^{\mathrm{int}})^{-1} & 0 \\
0 & Q_{\mathrm{int}}
\end{pmatrix},
$$
$$
H =
\bigl[\, W_{\mathrm{int}}\ \ I_n \,\bigr],
\quad
\boldsymbol{\eta}_{\mathrm{int}} = H \theta_{\mathrm{int}},
$$
と書くと，点過程部分＋事前分布に基づく $\theta_{\mathrm{int}}$ の「（比例）事後密度」は
$$
\begin{aligned}
\log p(\theta_{\mathrm{int}} \mid \cdots)
&=
-\frac{1}{2} (\boldsymbol{\eta}_{\mathrm{int}} - \boldsymbol{z})^\top \Omega (\boldsymbol{\eta}_{\mathrm{int}} - \boldsymbol{z})
-\frac{1}{2} (\boldsymbol{\beta}_{\mathrm{int}} - \boldsymbol{b}_0^{\mathrm{int}})^\top (B_0^{\mathrm{int}})^{-1}(\boldsymbol{\beta}_{\mathrm{int}} - \boldsymbol{b}_0^{\mathrm{int}}) \\
&\hphantom{=}
-\frac{1}{2} \boldsymbol{u}_{\mathrm{int}}^\top Q_{\mathrm{int}} \boldsymbol{u}_{\mathrm{int}}
+ \text{const}\\[1mm]
&=
-\frac{1}{2} (H\theta_{\mathrm{int}} - \boldsymbol{z})^\top \Omega (H\theta_{\mathrm{int}} - \boldsymbol{z})
-\frac{1}{2} (\theta_{\mathrm{int}} - \mu_0)^\top R_0 (\theta_{\mathrm{int}} - \mu_0)
+ \text{const}.
\end{aligned}
$$

右辺を $\theta_{\mathrm{int}}$ について二乗完成する．まず
$$
(H\theta_{\mathrm{int}} - \boldsymbol{z})^\top \Omega (H\theta_{\mathrm{int}} - \boldsymbol{z})
=
\theta_{\mathrm{int}}^\top H^\top \Omega H \theta_{\mathrm{int}}
- 2\theta_{\mathrm{int}}^\top H^\top \Omega \boldsymbol{z}
+ \boldsymbol{z}^\top \Omega \boldsymbol{z},
$$
$$
(\theta_{\mathrm{int}} - \mu_0)^\top R_0 (\theta_{\mathrm{int}} - \mu_0)
=
\theta_{\mathrm{int}}^\top R_0 \theta_{\mathrm{int}}
- 2\theta_{\mathrm{int}}^\top R_0 \mu_0
+ \mu_0^\top R_0 \mu_0.
$$

したがって
$$
\begin{aligned}
\log p(\theta_{\mathrm{int}} \mid \cdots)
&=
-\frac{1}{2} \theta_{\mathrm{int}}^\top (H^\top \Omega H + R_0)\theta_{\mathrm{int}}
+ \theta_{\mathrm{int}}^\top (H^\top \Omega \boldsymbol{z} + R_0 \mu_0)
+ \text{const}.
\end{aligned}
$$

さらに
$$
V_{\mathrm{int}}^{-1} = H^\top \Omega H + R_0,
\qquad
\boldsymbol{m}_{\mathrm{int}} =
V_{\mathrm{int}}(H^\top \Omega \boldsymbol{z} + R_0 \mu_0),
$$
とおくと，
$$
\begin{aligned}
&\theta_{\mathrm{int}}^\top V_{\mathrm{int}}^{-1}\theta_{\mathrm{int}}
- 2\theta_{\mathrm{int}}^\top V_{\mathrm{int}}^{-1}\boldsymbol{m}_{\mathrm{int}}
\\
&=
(\theta_{\mathrm{int}} - \boldsymbol{m}_{\mathrm{int}})^\top
V_{\mathrm{int}}^{-1}
(\theta_{\mathrm{int}} - \boldsymbol{m}_{\mathrm{int}})
- \boldsymbol{m}_{\mathrm{int}}^\top V_{\mathrm{int}}^{-1}\boldsymbol{m}_{\mathrm{int}},
\end{aligned}
$$
であり，上と係数を対応させると
$$
\log p(\theta_{\mathrm{int}} \mid \cdots)
=
-\frac{1}{2}
(\theta_{\mathrm{int}} - \boldsymbol{m}_{\mathrm{int}})^\top
V_{\mathrm{int}}^{-1}
(\theta_{\mathrm{int}} - \boldsymbol{m}_{\mathrm{int}})
+ \text{const},
$$
となる．

したがって，
$$
\boxed{
\theta_{\mathrm{int}} \mid \boldsymbol{\omega}, X_{\mathrm{all}}, U
\sim
\mathcal{N}\bigl(\boldsymbol{m}_{\mathrm{int}}, V_{\mathrm{int}}\bigr)
}
$$
であり，ここから $(\boldsymbol{\beta}_{\mathrm{int}},\ \boldsymbol{u}_{\mathrm{int}})$ を同時にサンプルすることができる．$V_{\mathrm{int}}$ は大きな行列だが，NNGP により $Q_{\mathrm{int}}$ がスパースであること，$H^\top \Omega H$ もスパース構造を持つことを用いて，反復解法などで効率的に扱うことを想定する．

---

### 5.2 $\lambda^*$ の完全条件付き分布

$\lambda^*$ に関する項だけを取り出すと，
$$
p(\lambda^* \mid \cdots)
\propto
p(\lambda^*)\,
\exp\{-\lambda^*|\mathcal{S}|\}
(\lambda^*)^{n},
$$
事前分布を $\lambda^* \sim \mathrm{Gamma}(m_0, r_0)$ としているので，
$$
p(\lambda^* \mid \cdots)
\propto
(\lambda^*)^{m_0-1} e^{-r_0\lambda^*}
\times
e^{-\lambda^*|\mathcal{S}|}
(\lambda^*)^{n}.
$$
よって
$$
p(\lambda^* \mid \cdots)
\propto
(\lambda^*)^{m_0 + n - 1}
\exp\{-(r_0+|\mathcal{S}|)\lambda^*\},
$$
となり，
$$
\boxed{
\lambda^* \mid X_{\mathrm{all}}, U
\sim
\mathrm{Gamma}\bigl(m_0 + n,\ r_0 + |\mathcal{S}|\bigr).
}
$$

---

### 5.3 偽不在点過程 $U$ の完全条件付き分布

$U$ の完全条件付き分布は，
$$
p(U \mid X_{\mathrm{all}}, \lambda^*, \boldsymbol{\beta}_{\mathrm{int}}, \boldsymbol{u}_{\mathrm{int}})
\propto
p(X_{\mathrm{all}}, U \mid \lambda^*, q),
$$
であり，先の計算から
$$
p(X_{\mathrm{all}}, U \mid \lambda^*, q)
=
\exp\{-\lambda^*|\mathcal{S}|\}
\frac{(\lambda^*)^{n}}{n_X!\,n_U!}
\prod_{i=1}^n
q(s_i)^{y_i}(1-q(s_i))^{1-y_i}
$$
である．このうち $U$ に依存する部分だけを見ると
$$
\begin{aligned}
p(U \mid \cdots)
&\propto
\exp\left\{
-\lambda^*\int_{\mathcal{S}} (1-q(s))\,ds
\right\}
\frac{(\lambda^*)^{n_U}}{n_U!}
\prod_{i=n_X+1}^{n}
(1-q(s_i)).
\end{aligned}
$$
これは
$$
U \mid \lambda^*, q \sim \mathrm{IPP}(\lambda^*(1-q))
$$
と一致している．したがって，完全条件付き分布は再び同じ非斉次ポアソン過程になっている：
$$
\boxed{
U \mid \lambda^*, \boldsymbol{\beta}_{\mathrm{int}}, \boldsymbol{u}_{\mathrm{int}}
\sim
\mathrm{IPP}\bigl(\lambda^*(1-q)\bigr).
}
$$

実際のサンプリングでは，Poisson thinning を用いる（§7.2 参照）．

---

### 5.4 Polya–Gamma 変数 $\omega_i$ の完全条件付き分布

Polson et al. (2013) の Theorem 1 によれば，
$$
\omega \sim \mathrm{PG}(b,0),\quad
\psi \in \mathbb{R}
$$
に対して，
$$
p(\omega \mid \psi)
\propto
\exp\left(-\frac{\omega \psi^2}{2}\right)p(\omega)
$$
は $\mathrm{PG}(b,\psi)$ である．

本モデルでは点過程部分で $b=1$ としていたので，
$$
\boxed{
\omega_i \mid \eta_{\mathrm{int},i}
\sim
\mathrm{PG}\bigl(1,\ \eta_{\mathrm{int},i}\bigr),
\quad
\eta_{\mathrm{int},i} = \boldsymbol{w}_{\mathrm{int}}(s_i)^\top \boldsymbol{\beta}_{\mathrm{int}} + u_{\mathrm{int}}(s_i),
}
$$
となる．ギブスサンプリングでは，各ステップで $\eta_{\mathrm{int},i}$ を更新した後に，この条件付き分布から $\omega_i$ を個別にサンプルすればよい．
