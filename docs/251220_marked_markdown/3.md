## 3 階層ベイズモデルの全体構造

前節では，遺跡位置に対する空間ポアソン点過程と，各時期のマーク（産地構成比）に対する多項ロジットモデルを，それぞれ定式化した．本節では，これらを一つの階層ベイズモデルとして統合し，事前分布を含めた全体構造を明示する．

### 3.1 パラメータ集合の定義

本モデルの重要な特徴は，点過程部分とマーク部分のパラメータが分離されている点にある．

#### 点過程部分のパラメータ（全時期共通）

$$
\Theta_{\mathrm{int}} = \left\{
\lambda^*,\,
\boldsymbol{\beta}_{\mathrm{int}},\,
u_{\mathrm{int}}(\cdot)
\right\}
$$

ここで：
- $\lambda^* > 0$：上限強度パラメータ
- $\boldsymbol{\beta}_{\mathrm{int}}$：遺跡存在に関する共変量の係数ベクトル
- $u_{\mathrm{int}}(\cdot)$：空間的な潜在ガウス場

#### マーク部分のパラメータ（時期 $t$ 固有）

各時期 $t = 1, \dots, T$ について：
$$
\Theta_{\mathrm{mark},t} = \left\{
\{\boldsymbol{\beta}_{tk}\}_{k=1}^{K-1},\,
\{u_{tk}(\cdot)\}_{k=1}^{K-1}
\right\}
$$

ここで：
- $\boldsymbol{\beta}_{tk}$：時期 $t$，産地 $k$ の回帰係数ベクトル
- $u_{tk}(\cdot)$：時期 $t$，産地 $k$ の潜在ガウス場

全パラメータをまとめて
$$
\Theta = \Theta_{\mathrm{int}} \cup \bigcup_{t=1}^T \Theta_{\mathrm{mark},t}
$$
と書く．

### 3.2 観測データ

観測データは以下の二つの部分からなる：

1. **遺跡位置**：全時期の遺跡を統合した集合
   $$
   X_{\mathrm{all}} = \{s_i : i = 1, \dots, n_X\}
   $$

2. **マーク**：各時期 $t$ におけるマークデータの集合
   $$
   \mathcal{Y}_t = \{\boldsymbol{y}_{it} : i \in I_t\}, \quad t = 1, \dots, T
   $$

### 3.3 尤度の因子分解

本モデルの構造から，尤度は以下のように因子分解される：

$$
\boxed{
p\bigl(X_{\mathrm{all}}, \{\mathcal{Y}_t\}_{t=1}^T \mid \Theta\bigr)
=
\underbrace{p(X_{\mathrm{all}} \mid \Theta_{\mathrm{int}})}_{\text{点過程尤度}}
\times
\prod_{t=1}^T \underbrace{p(\mathcal{Y}_t \mid X_t, \Theta_{\mathrm{mark},t})}_{\text{マーク尤度（時期 $t$）}}
}
$$

この因子分解が成立する理由は：

1. **点過程部分**は $\Theta_{\mathrm{int}}$ のみに依存し，マークパラメータには依存しない
2. **マーク部分**は，与えられた遺跡位置 $X_t$ のもとで，$\Theta_{\mathrm{mark},t}$ のみに依存する
3. **時期間の独立性**：仮定 2.2 より，異なる時期のマークモデルは互いに独立

**定理 3.1**（2段階推定の正当性）：上記の因子分解により，点過程部分とマーク部分を別々に推定する2段階推定が理論的に正当化される．すなわち：

- Stage 1：$X_{\mathrm{all}}$ のみを用いて $\Theta_{\mathrm{int}}$ を推定
- Stage 2：各 $t$ について $X_t, \mathcal{Y}_t$ を用いて $\Theta_{\mathrm{mark},t}$ を推定

### 3.4 事前分布

#### 点過程部分の事前分布

1. **上限強度**：
   $$
   \lambda^* \sim \mathrm{Gamma}(m_0, r_0)
   $$

2. **回帰係数**：
   $$
   \boldsymbol{\beta}_{\mathrm{int}} \sim \mathcal{N}(\boldsymbol{b}_0^{\mathrm{int}}, B_0^{\mathrm{int}})
   $$

3. **潜在ガウス場**（NNGP 近似）：
   $X_{\mathrm{all}}$ の位置における $u_{\mathrm{int}}$ のベクトル
   $$
   \boldsymbol{u}_{\mathrm{int}} = \bigl(u_{\mathrm{int}}(s_1), \dots, u_{\mathrm{int}}(s_{n_X})\bigr)^\top
   \sim
   \mathcal{N}\bigl(\boldsymbol{0}, Q_{\mathrm{int}}^{-1}\bigr)
   $$
   ここで $Q_{\mathrm{int}}$ は NNGP によって与えられるスパースな精度行列である．

#### マーク部分の事前分布（各時期 $t$）

各時期 $t$ と各カテゴリ $k = 1, \dots, K-1$ について：

1. **回帰係数**：
   $$
   \boldsymbol{\beta}_{tk} \sim \mathcal{N}(\boldsymbol{b}_0^{(tk)}, B_0^{(tk)})
   $$
   距離依存事前分布を用いる場合，$\boldsymbol{b}_0^{(tk)}$ の切片成分には $\lambda_k \cdot g_k(s)$ を組み込む．

2. **潜在ガウス場**（NNGP 近似）：
   時期 $t$ の観測点集合 $\{s_i : i \in I_t\}$ における $u_{tk}$ のベクトル
   $$
   \boldsymbol{u}_{tk} = \bigl(u_{tk}(s_i)\bigr)_{i \in I_t}
   \sim
   \mathcal{N}\bigl(\boldsymbol{0}, Q_{tk}^{-1}\bigr)
   $$
   ここで $Q_{tk}$ は NNGP の精度行列である．

**重要**：異なる時期のパラメータは事前分布においても独立である：
$$
p\bigl(\{\Theta_{\mathrm{mark},t}\}_{t=1}^T\bigr)
=
\prod_{t=1}^T p(\Theta_{\mathrm{mark},t})
$$

### 3.5 階層構造の図解

モデルの階層構造を以下に整理する：

```
[Stage 1: 点過程（全時期共通）]
    ├── λ* ~ Gamma(m₀, r₀)
    ├── β_int ~ N(b₀, B₀)
    ├── u_int ~ NNGP(0, Q_int⁻¹)
    │
    └── X_all ~ IPP(λ* · q)
            ↓
[Stage 2: マーク（時期別・独立）]
    ├── 時期 t=1
    │   ├── β_{1k} ~ N(b₀, B₀)  (k=1,...,K-1)
    │   ├── u_{1k} ~ NNGP(0, Q_{1k}⁻¹)
    │   └── Y₁ | X₁ ~ Multinomial(N, π₁)
    │
    ├── 時期 t=2
    │   ├── β_{2k} ~ N(b₀, B₀)
    │   ├── u_{2k} ~ NNGP(0, Q_{2k}⁻¹)
    │   └── Y₂ | X₂ ~ Multinomial(N, π₂)
    │
    ⋮
    │
    └── 時期 t=T
        ├── β_{Tk} ~ N(b₀, B₀)
        ├── u_{Tk} ~ NNGP(0, Q_{Tk}⁻¹)
        └── Y_T | X_T ~ Multinomial(N, π_T)
```

### 3.6 事後分布

事後分布は，ベイズの定理より
$$
p(\Theta \mid X_{\mathrm{all}}, \{\mathcal{Y}_t\}_{t=1}^T)
\propto
p\bigl(X_{\mathrm{all}}, \{\mathcal{Y}_t\}_{t=1}^T \mid \Theta\bigr)
\times
p(\Theta)
$$
で与えられる．尤度の因子分解（§3.3）と事前分布の独立性から，これは
$$
p(\Theta \mid \text{data})
\propto
\underbrace{p(X_{\mathrm{all}} \mid \Theta_{\mathrm{int}}) p(\Theta_{\mathrm{int}})}_{\text{点過程部分}}
\times
\prod_{t=1}^T
\underbrace{p(\mathcal{Y}_t \mid X_t, \Theta_{\mathrm{mark},t}) p(\Theta_{\mathrm{mark},t})}_{\text{マーク部分（時期 $t$）}}
$$
と書ける．

この構造により，点過程部分とマーク部分を独立に推定することが可能となる．具体的なギブスサンプリングアルゴリズムは §7 で述べる．
